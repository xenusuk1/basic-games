#lang "qb"
' change C to CN
' change D to DN
' change Q to QN
' dim Z(7) for max players
' D() Discard()
' I$ IN$

PRINT TAB(31);"BLACK JACK"
PRINT TAB(15);"CREATIVE COMPUTING  MORRISTOWN, NEW JERSEY"
PRINT:PRINT:PRINT

REM DEF FNA(Q)=Q+11*(Q>=22)

DIM SHARED P(15,12),Q(15),C(52),Discard(52),T(8),S(7),B(15) AS Integer
DIM SHARED R(15), Z(7) AS Integer
DIM SHARED DN, CN, X, QN, Q2, I, J, D1, N, H, AA, AB, AC, H1 AS Integer

REM--P(I,J) IS THE JTH CARD IN HAND I, Q(I) IS TOTAL OF HAND I
REM--C IS THE DECK BEING DEALT FROM, Discard() IS THE DISCARD PILE,
REM--T(I) IS THE TOTAL FOR PLAYER I, S(I) IS THE TOTAL THIS HAND FOR
REM--PLAYER I, B(I) IS TH BET FOR HAND I
REM--R(I) IS THE LENGTH OF P(I,*) - count of cards in hand P

'setup deck in D()
CONST D$="N A  2  3  4  5  6  7N 8  9 10  J  Q  K"
CONST IN$="H,S,D,/,"

FOR I=1 TO 13
FOR J=4*I-3 TO 4*I
	Discard(J)=I
NEXT J
NEXT I

'force initial shuffle
DN=52
CN=53

GOTO 1500

' Subroutines

SUB GetCard
REM--SUBROUTINE TO GET A CARD from c().  RESULT IS PUT IN X.
IF CN>=51 THEN CALL Shuffle
X=C(CN)
CN=CN+1
END SUB

SUB Shuffle
PRINT "RESHUFFLING"
' move discards to deck
FOR DN=DN TO 1 STEP -1
	CN=CN-1
	C(CN)=Discard(DN)
NEXT DN
' shuffle deck
FOR C1=52 TO CN STEP -1
	C2=INT(RND(1)*(C1-CN+1))+CN
	C3=C(C2)
	C(C2)=C(C1)
	C(C1)=C3
NEXT C1
END SUB

SUB EvalHand
REM --SUBROUTINE TO EVALUATE HAND I.  TOTAL IS PUT INTO
REM --Q(I). TOTALS HAVE THE FOLLOWING MEANING:
REM --  2-10...HARD 2-10
REM -- 11-21...SOFT 11-21
REM -- 22-32...HARD 11-21
REM --  33+....BUSTED or -1
' use 3400 to convert to human hand value
' AA=AA+11*(AA>=22)
' 0 false -1 true
QN=0
FOR Q2=1 TO R(I)
	X=P(I,Q2)  'select card Q2 from hand I in X
	CALL AddCard
NEXT Q2
Q(I)=QN  'set player I total to QN
PRINT "Tot ", Q(I), Q(I)+11*(Q(I)>=22)
END SUB

SUB AddCard
REM--SUBROUTINE TO ADD CARD X TO TOTAL Q.
' Return QN as new card value adding X
X1=X: IF X1>10 THEN X1=10:  REM  SAME AS X1=10 MIN X
Q1=QN+X1
IF QN>=11 THEN
	QN=Q1-(QN<=21 AND Q1>21)
	IF QN>32 THEN QN=-1  ' Busted
ELSEIF X>1 THEN QN=Q1-11*(Q1>=11)
ELSE
	QN=QN+11
END IF
END SUB

SUB CardP1 (DP$)
REM--CARD PRINTING SUBROUTINE
PRINT MID$(DP$,3*X-2,3);
PRINT "  ";
END SUB

SUB CardP2 (DP$)
REM--ALTERNATIVE PRINTING ROUTINE
PRINT " ";MID$(DP$,3*X-1,2);
PRINT "   ";
END SUB

'play rest of hand
800 REM--SUBROUTINE TO PLAY OUT A HAND.
810 REM--NO SPLITTING OR BLACKJACKS ALLOWED
820 H1=5
'inner hit loop
830 CALL Reply (IN$, H1)
840 H1=3
850 ON H GOTO 950,930

' double
860 CALL GetCard
870 B(I)=B(I)*2
880 PRINT "RECEIVED A";
CALL CardP1 (D$)
CALL AddCardI
'900 GOSUB 1100
910 IF QN>0 THEN CALL Ptotal
920 RETURN

'Stick
'930 GOSUB 1320
930 CALL Ptotal
940 RETURN

'Hit
950 CALL GetCard
960 PRINT "RECEIVED A";
CALL CardP1 (D$)
CALL AddCardI
'980 GOSUB 1100
CALL Ptotal
990 IF QN<0 THEN 940
PRINT
1000 PRINT "HIT (H or S)";
1010 GOTO 830

SUB AddCardI
REM--SUBROUTINE TO ADD A CARD TO ROW I
1110 R(I)=R(I)+1
1120 P(I,R(I))=X
1130 QN=Q(I)

CALL AddCard
Q(I)=QN
IF QN<0 THEN
	PRINT "...BUSTED"
	CALL DiscardI
END IF
END SUB
'1190 RETURN

SUB DiscardI
REM--SUBROUTINE TO DISCARD Hand I
'1210 IF R(I)<>0 THEN 1230
'1220 RETURN
'1230 DN=DN+1
'1240 Discard(DN)=P(I,R(I))
'1250 R(I)=R(I)-1
'1260 GOTO 1210
WHILE R(I)>0
	DN=DN+1
	Discard(DN)=P(I,R(I))
	R(I)=R(I)-1
WEND
END SUB

SUB Ptotal
REM--PRINTS TOTAL OF HAND I
AA=Q(I)
'PRINT Q(I), AA
CALL getAA
PRINT "TOTAL IS";AA
END SUB

SUB Reply (IP$, H1%)
REM --SUBROUTINE TO READ REPLY
1420 INPUT H$: H$=UCASE$(LEFT$(H$,1))
FOR H=1 TO H1% STEP 2
	IF H$=MID$(IP$,H,1) THEN 1480
NEXT H
PRINT H$, IP$, H1%, H
PRINT "TYPE ";MID$(IP$,1,H1%-1);" OR ";MID$(IP$,H1%,2);" PLEASE";
GOTO 1420
1480 H=(H+1)/2  'return value 1-4
'PRINT H$, IP$, H1%, H
END SUB

SUB Initialize
REM--INITIALIZE
PRINT "DO YOU WANT INSTRUCTIONS";
INPUT H$
IF UCASE$(LEFT$(H$,1))="Y" THEN 
PRINT "THIS IS THE GAME OF 21. AS MANY AS 7 PLAYERS MAY PLAY THE"
PRINT "GAME. ON EACH DEAL, BETS WILL BE ASKED FOR, AND THE"
PRINT "PLAYERS' BETS SHOULD BE TYPED IN. THE CARDS WILL THEN BE"
PRINT "DEALT, AND EACH PLAYER IN TURN PLAYS HIS HAND. THE"
PRINT "FIRST RESPONSE SHOULD BE EITHER 'D', INDICATING THAT THE"
PRINT "PLAYER IS DOUBLING DOWN, 'S', INDICATING THAT HE IS"
PRINT "STANDING, 'H', INDICATING HE WANTS ANOTHER CARD, OR '/',"
PRINT "INDICATING THAT HE WANTS TO SPLIT HIS CARDS. AFTER THE"
PRINT "INITIAL RESPONSE, ALL FURTHER RESPONSES SHOULD BE 'S' OR"
PRINT "'H', UNLESS THE CARDS WERE SPLIT, IN WHICH CASE DOUBLING"
PRINT "DOWN IS AGAIN PERMITTED. IN ORDER TO COLLECT FOR"
PRINT "BLACKJACK, THE INITIAL RESPONSE SHOULD BE 'S'."
ENDIF

DO
	PRINT "NUMBER OF PLAYERS";
	INPUT N
	N=INT(N)
	PRINT
LOOP UNTIL N>=1 AND N<=7

FOR I=1 TO 8: T(I)=0: NEXT I

D1=N+1  'D1 players+1 (dealer)
END SUB

1500 REM--PROGRAM STARTS HERE
CALL Initialize

'Main loop starts here - deal new hand
1810 IF 2*D1+CN>=52 THEN CALL Shuffle
IF CN=2 THEN CN=CN-1

'Reset hand variables
FOR I=1 TO N: Z(I)=0: NEXT I
FOR I=1 TO 15: B(I)=0: NEXT I
FOR I=1 TO 15: Q(I)=0: NEXT I
FOR I=1 TO 7: S(I)=0: NEXT I
FOR I=1 TO 15: R(I)=0: NEXT I

' get bet max 500
PRINT "BETS:"
FOR I=1 TO N
	DO
		PRINT "#";I;
		INPUT Z(I)
	LOOP UNTIL Z(I)>0 AND Z(I)<=500
	B(I)=Z(I)
NEXT I

' print header
PRINT "PLAYER";
FOR I=1 TO N
	PRINT I;"   ";
NEXT I
PRINT "DEALER"

FOR J=1 TO 2  'get 2 cards each
PRINT TAB(5);

' deal cards to hands & print
FOR I=1 TO D1
	CALL GetCard
	P(I,J)=X  'put card X in P()
	IF J=1 OR I<=N THEN CALL CardP2 (D$)  'show first or player card
NEXT I
PRINT
NEXT J

' set number of dealt cards to 2
FOR I=1 TO D1
	R(I)=2
NEXT I

REM--TEST FOR INSURANCE (dealer has Ace)
IF P(D1,1)=1 THEN 
PRINT "ANY INSURANCE";
INPUT H$
IF UCASE$(LEFT$(H$,1))="Y" THEN
	PRINT "INSURANCE BETS max 1/2 bet"
	FOR I=1 TO N
	DO
		PRINT "#";I;
		INPUT Z(I)
	LOOP UNTIL Z(I)>=0 AND Z(I)<=B(I)/2
	NEXT I
	FOR I=1 TO N
		S(I)=Z(I)*(3*(-(P(D1,2)>=10))-1)
	NEXT I
END IF
END IF 'Ace

REM--TEST FOR DEALER BLACKJACK
' look for 10 and A combos
L1=1: L2=1
IF P(D1,1)=1 AND P(D1,2)>9 THEN L1=0: L2=0
IF P(D1,2)=1 AND P(D1,1)>9 THEN L1=0: L2=0
IF L1=0 AND L2=0 THEN
	PRINT:PRINT "DEALER HAS A";MID$(D$,3*P(D1,2)-2,3);" IN THE HOLE ";
	PRINT "FOR BLACKJACK"
	FOR I=1 TO D1
		CALL EvalHand
	NEXT I
	GOTO 3140   'tally result
ELSE
	PRINT "(NO DEALER BLACKJACK)."
ENDIF

REM--NO DEALER BLACKJACK
'IF P(D1,1)>1 AND P(D1,1)<10 THEN 2350  'not a A or 10
'PRINT "(NO DEALER BLACKJACK)."

2350 REM--NOW PLAY THE HANDS for each player I
' main hands loop
2360 FOR I=1 TO N

2370 PRINT "PLAYER";I;" HSD/";
2380 H1=7  ' reset H1
CALL Reply (IN$,H1)

2400 ON H GOTO 2550,2410,2510,2600

2410 REM--PLAYER WANTS TO STAND
CALL EvalHand

IF Q(I)=21 THEN
	2440 PRINT "PLAYER BLACKJACK"
	2450 S(I)=S(I)+1.5*B(I)
	2460 B(I)=0
	CALL DiscardI
ELSE
	2490 CALL Ptotal
END IF
2500 GOTO 2900

2510 REM--PLAYER WANTS TO DOUBLE DOWN
' Doubling down is making a bet equal to your initial wager after being dealt your first 2 cards.
' You only get dealt 1 more card and cannot hit
CALL EvalHand
2530 GOSUB 860
2540 GOTO 2900

2550 REM--PLAYER WANTS TO BE HIT
CALL EvalHand
2570 H1=3
2580 GOSUB 950
2590 GOTO 2900

2600 REM--PLAYER WANTS TO SPLIT
2610 L1=P(I,1): IF P(I,1)>10 THEN L1=10
2612 L2=P(I,2): IF P(I,2)>10 THEN L2=10
2614 IF L1=L2 THEN 2640
2620 PRINT "SPLITTING NOT ALLOWED."
2630 GOTO 2370
2640 REM--PLAY OUT SPLIT
2650 I1=I+D1
2660 R(I1)=2
2670 P(I1,1)=P(I,2)
2680 B(I+D1)=B(I)
CALL GetCard

2700 PRINT "FIRST HAND RECEIVES A";
CALL CardP1 (D$)
2720 P(I,2)=X
CALL EvalHand

2740 PRINT
CALL GetCard

2760 PRINT "SECOND HAND RECEIVES A";
2770 I=I1
CALL CardP1 (D$)
2790 P(I,2)=X
CALL EvalHand
2810 PRINT
2820 I=I1-D1
2830 IF P(I,1)=1 THEN 2900

2840 REM--NOW PLAY THE TWO HANDS
2850 PRINT "HAND";1-(I>D1);
2860 GOSUB 800
2870 I=I+D1
2880 IF I=I1 THEN 2850
2890 I=I1-D1
2900 NEXT I
' end of hands loop

CALL EvalHand

2920 REM--TEST FOR PLAYING DEALER'S HAND
2930 FOR I=1 TO N
2940 IF R(I)>0 OR R(I+D1)>0 THEN 3010
2950 NEXT I
2960 PRINT "DEALER HAD A";
2970 X=P(D1,2)
CALL CardP1 (D$)
2990 PRINT " CONCEALED."
3000 GOTO 3140
3010 PRINT "DEALER HAS A";MID$(D$,3*P(D1,2)-2,3);" CONCEALED ";
3020 I=D1
3030 AA=Q(I): GOSUB 3400
3035 PRINT "FOR A TOTAL OF";AA
3040 IF AA>16 THEN 3130
3050 PRINT "DRAWS";
3060 CALL GetCard

CALL CardP2 (D$)
CALL AddCardI
'3080 GOSUB 1100
3090 AA=QN: GOSUB 3400
3095 IF QN>0 AND AA<17 THEN 3060
3100 Q(I)=QN-(QN<0)/2
3110 IF QN<0 THEN 3140
3120 AA=QN: GOSUB 3400
3125 PRINT "---TOTAL IS";AA
3130 PRINT

3140 REM--TALLY THE RESULT
3150 REM
3160 Z$="LOSES PUSHES WINS "
3165 PRINT

3170 FOR I=1 TO N
3180 AA=Q(I): GOSUB 3400
3182 AB=Q(I+D1): GOSUB 3410
3184 AC=Q(D1): GOSUB 3420
3186 S(I)=S(I)+B(I)*SGN(AA-AC)+B(I+D1)*SGN(AB-AC)
3188 B(I+D1)=0
3200 PRINT "PLAYER";I;" ";
3210 PRINT MID$(Z$,SGN(S(I))*6+7,6);" ";
3220 IF S(I)<>0 THEN 3250
3230 PRINT "      ";
3240 GOTO 3260
3250 PRINT ABS(S(I));
3260 T(I)=T(I)+S(I)
3270 PRINT " TOTAL=";T(I)
CALL DiscardI
'3280 GOSUB 1200
3290 T(D1)=T(D1)-S(I)
3300 I=I+D1
CALL DiscardI
'3310 GOSUB 1200
3320 I=I-D1
3330 NEXT I

3340 PRINT "DEALER'S TOTAL=";T(D1)
3345 PRINT
CALL DiscardI
'3350 GOSUB 1200
3360 GOTO 1810   'back to main loop

3400 AA=AA+11*(AA>=22): RETURN

SUB getAA
AA=AA+11*(AA>=22)
END SUB

SUB getAB
AB=AB+11*(AB>=22)
END SUB

SUB getAC
AC=AC+11*(AC>=22)
END SUB

3410 AB=AB+11*(AB>=22): RETURN

3420 AC=AC+11*(AC>=22): RETURN
